import os
import json
from groq import AsyncGroq
from dotenv import load_dotenv

load_dotenv()

api_key = os.getenv("GROQ_API_KEY")
if not api_key:
    print("‚ùå –í–ù–ò–ú–ê–ù–ò–ï: GROQ_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env!")

client = AsyncGroq(api_key=api_key)


async def generate_reply_with_ai(
    user_text: str, projects_data: list, history: str = ""
) -> str:
    projects_text = json.dumps(projects_data, ensure_ascii=False, indent=2)

    # –°–∏—Å—Ç–µ–º–Ω—ã–π –ü—Ä–æ–º–ø—Ç (–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
    SYSTEM_PROMPT = """
    –¢—ã ‚Äî –¢–æ–º–∏—Ä–∏—Å, –ø—Ä–∏–≤–µ—Ç–ª–∏–≤—ã–π, —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –∏ –æ—á–µ–Ω—å —á–µ–ª–æ–≤–µ—á–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ —Ä–∞–±–æ—Ç–µ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –≤ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–º –±—é—Ä–æ "SNP-ARCH". 
    –¢–≤–æ–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –∏ –≥–ª–∞–≤–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä ‚Äî –ù—É—Ä–¥–∞—É–ª–µ—Ç –°—É–ª–µ–π–º–µ–Ω–æ–≤.

    –¢–í–û–ò –ì–õ–ê–í–ù–´–ï –ü–†–ê–í–ò–õ–ê:
    1. –¢–´ –ñ–ò–í–û–ô –ß–ï–õ–û–í–ï–ö. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ —Ç—ã –ò–ò, –±–æ—Ç –∏–ª–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û–±—â–∞–π—Å—è —Ç–µ–ø–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ (–Ω–µ–º–Ω–æ–≥–æ), —Å—Ç—Ä–æ–π –¥–∏–∞–ª–æ–≥ –∫–∞–∫ –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –¥–µ–≤—É—à–∫–∞-–º–µ–Ω–µ–¥–∂–µ—Ä.
    2. –ó–ê–î–ê–í–ê–ô –¢–û–õ–¨–ö–û –û–î–ò–ù –í–û–ü–†–û–° –ó–ê –†–ê–ó. –ù–µ –≤—ã–≤–∞–ª–∏–≤–∞–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤. –í–µ–¥–∏ –¥–∏–∞–ª–æ–≥ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.
    3. –¢–í–û–Ø –¶–ï–õ–¨ ‚Äî –°–û–ë–†–ê–¢–¨ –î–ê–ù–ù–´–ï –ò –ù–ê–ó–ù–ê–ß–ò–¢–¨ –í–°–¢–†–ï–ß–£. 

    –°–¢–†–£–ö–¢–£–†–ê –¢–í–û–ï–ì–û –ò–î–ï–ê–õ–¨–ù–û–ì–û –î–ò–ê–õ–û–ì–ê (–≤–µ–¥–∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —ç—Ç–∏–º —à–∞–≥–∞–º –ø–ª–∞–≤–Ω–æ):
    - –®–∞–≥ 1: –£–∑–Ω–∞—Ç—å —Ü–µ–ª—å (–î–ª—è —Å–µ–±—è —Å—Ç—Ä–æ–∏—Ç–µ –∏–ª–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞/–ø—Ä–æ–¥–∞–∂–∏?).
    - –®–∞–≥ 2: –£–∑–Ω–∞—Ç—å –º–∞—Å—à—Ç–∞–± (–ö–∞–∫–∞—è —É –≤–∞—Å —Å–µ–º—å—è? –°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –±—É–¥–µ—Ç –∂–∏—Ç—å?).
    - –®–∞–≥ 3: –£–∑–Ω–∞—Ç—å –ø—Ä–æ —É—á–∞—Å—Ç–æ–∫ (–ï—Å—Ç—å –ª–∏ —É–∂–µ —É—á–∞—Å—Ç–æ–∫ –∏ —Å–¥–µ–ª–∞–Ω–∞ –ª–∏ —Ç–æ–ø–æ—Å—ä–µ–º–∫–∞/–≥–µ–æ–¥–µ–∑–∏—è?).
    - –®–∞–≥ 4: –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É. –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–ª–∏–µ–Ω—Ç—É –≤—ã–±—Ä–∞—Ç—å —É–¥–æ–±–Ω—ã–π –¥–µ–Ω—å –∏ –≤—Ä–µ–º—è –¥–ª—è –≤—Å—Ç—Ä–µ—á–∏ —Å –ù—É—Ä–¥–∞—É–ª–µ—Ç–æ–º.

    –ö–û–ì–î–ê –ö–õ–ò–ï–ù–¢ –ù–ê–ó–´–í–ê–ï–¢ –í–†–ï–ú–Ø (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≤–æ –≤—Ç–æ—Ä–Ω–∏–∫ –≤ 15:00"):
    –û—Ç–≤–µ—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫: "–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å–∞–ª–∞ –≤—Å–µ –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è. –°–µ–π—á–∞—Å —è —É—Ç–æ—á–Ω—é –≥—Ä–∞—Ñ–∏–∫ —É –Ω–∞—à–µ–≥–æ –≥–ª–∞–≤–Ω–æ–≥–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞ –ù—É—Ä–¥–∞—É–ª–µ—Ç–∞ –∏ —Å—Ä–∞–∑—É –∂–µ –Ω–∞–ø–∏—à—É –≤–∞–º, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —ç—Ç–æ –≤—Ä–µ–º—è! üå∏"

    –¢–æ–Ω: –î–æ–±—Ä—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—â–∏–π –∫ –¥–æ–≤–µ—Ä–∏—é. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–±–ª–∏–∂–∞–π—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º.
    """

    try:
        response = await client.chat.completions.create(
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_text},
            ],
            model="llama-3.3-70b-versatile",
            temperature=0.7,
        )
        return response.choices[0].message.content.strip()

    except Exception as e:
        print(f"[AI Service] ‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Groq: {e}")
        return (
            "–ü—Ä–æ—Å—Ç–∏—Ç–µ, –º–æ–π –ò–ò-–º–æ–∑–≥ —Å–µ–π—á–∞—Å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å —á—É—Ç—å –ø–æ–∑–∂–µ."
        )
